const translations = {
  "pt-pt": {
    heroEyebrow: "Convite",
    heroTitle: "InÃªs & Diego",
    heroSubtitle: "1 de agosto de 2026.",
    heroScroll: "Confirma a tua presenÃ§a",
    langToggle: "ES-PE",
    countdownTitle: "Contagem decrescente",
    countdownSubtitle: "Para o dia mais especial das nossas vidas.",
    daysLabel: "Dias",
    hoursLabel: "Horas",
    minutesLabel: "Minutos",
    secondsLabel: "Segundos",
    countdownNote: "Data e hora podem ser ajustadas no ficheiro principal.",
    storyTitle: "A nossa histÃ³ria",
    storySubtitle: "Pequenos capÃ­tulos que nos trouxeram atÃ© aqui.",
    story2013: "InÃªs e Diego conheceram-se nos colÃ©gios Fomento (Mira-Rio e Planalto).",
    story2014: "ComeÃ§aram a namorar cedo demais para saber o que era amar; o tempo levou-os por caminhos diferentes para amadurecer.",
    story2016: "Durante uma dÃ©cada seguiram caminhos distintos, mas a amizade manteve-se firme.",
    story2021: "Cresceram, e o destino voltou a cruzar os seus caminhos.",
    story2024: "Compraram a primeira casa e abriram a porta para a vida que queriam partilhar.",
    story2025: "Diego pediu InÃªs em noivado.",
    story2026: "O dia em que prometem ser um para sempre!",
    programTitle: "Programa do dia",
    programSubtitle: "Tudo pensado para um dia inesquecÃ­vel.",
    programCeremony: "Igreja Santo Quintino",
    programCeremonyDesc: "ReceÃ§Ã£o dos convidados e inÃ­cio da cerimÃ³nia religiosa",
    programToast: "Cocktail de Boas-Vindas",
    programToastDesc: "Chegada Ã  Quinta de SÃ£o GonÃ§alo",
    programDinner: "Jantar",
    programDinnerDesc: "Porque o amor tambÃ©m se celebra Ã  mesa",
    programParty: "Festa",
    programPartyDesc: "Vamos danÃ§ar atÃ© amanhecer!",
    programPartyEnd: "Ãšltimo brinde",
    programPartyEndDesc: "Despedida e boas memÃ³rias",
    locationTitle: "LocalizaÃ§Ãµes",
    locationSubtitle: "Dois lugares especiais para o nosso dia.",
    locationChurchName: "Igreja de Santo Quintino",
    locationChurchRole: "CerimÃ³nia religiosa",
    locationQuintaName: "Quinta de SÃ£o GonÃ§alo",
    locationQuintaRole: "Copo de Ã¡gua e festa",
    locationButton: "Abrir no Maps",
    transportTitle: "Transporte",
    transportSubtitle: "A Quinta de SÃ£o GonÃ§alo oferece estacionamento a todos os que pretenderem levar carro.",
    transportShuttle: "Transporte organizado",
    transportShuttleDesc: "SerÃ¡ estudado a opÃ§Ã£o de um autocarro comum. Pedimos que, caso estejam interessados, informem os noivos com brevidade.",
    transportOwn: "ServiÃ§o de Drivers",
    transportOwnDesc: "Para que possam usufruir da cerimÃ³nia e festas sem preocupaÃ§Ãµes, partilhamos o contacto de um coordenador de uma equipa de drivers:",
    galleryTitle: "Galeria",
    gallerySubtitle: "Alguns momentos que fazem parte da nossa histÃ³ria, desde mais pequenos atÃ© hoje!",
    rsvpTitle: "RSVP",
    rsvpSubtitle: "Confirma a tua presenÃ§a atÃ© dia 17 de abril 2026 para que possamos preparar tudo ao detalhe e com todo o nosso carinho.",
    rsvpName: "Nome",
    rsvpGuests: "NÃºmero de convidados",
    rsvpAttendance: "ConfirmaÃ§Ã£o",
    rsvpYes: "Sim",
    rsvpNo: "NÃ£o",
    rsvpNotes: "Tem alguma alergia, intolerÃ¢ncia ou restriÃ§Ã£o alimentar?",
    rsvpSubmit: "Enviar confirmaÃ§Ã£o",
    rsvpHelper: "Preparado para integraÃ§Ã£o com email ou base de dados.",
    rsvpSuccess: "Obrigado! A tua resposta foi registada.",
    faqTitle: "Perguntas frequentes",
    faqSubtitle: "Respostas rÃ¡pidas Ã s dÃºvidas mais comuns.",
    faqDressCode: "Dress code",
    faqDressCodeDesc: "Estamos certos que todos os convidados tÃªm bom gosto, pelo que apenas pedimos que tragam o vosso melhor outfit! Pedimos somente que evitem a cor branca e tons semelhantes.",
    faqKids: "Convidados",
    faqKidsDesc: "O convite jÃ¡ indica as pessoas que contamos ter connosco nesse dia. Agradecemos, por isso, que seja respeitado o nome das pessoas mencionadas no convite, para que tudo decorra como planeado.",
    faqSchedule: "HorÃ¡rios",
    faqScheduleDesc: "Recomendamos que cumpram pontualmente com os horÃ¡rios estipulados. A noiva Ã© a Ãºnica exceÃ§Ã£o, como manda a tradiÃ§Ã£o.",
    faqStay: "Alojamento",
    faqStayDesc:
      "HÃ¡ hotÃ©is parceiros nas proximidades. Contacta-nos para sugestÃµes.",
    giftsTitle: "Presentes",
    giftsSubtitle: "A vossa presenÃ§a Ã© o nosso maior presente, e tÃª-los connosco torna este dia jÃ¡ inesquecÃ­vel. Para quem quiser juntar-se a nÃ³s de forma ainda mais especial, deixamos aqui informaÃ§Ãµes para contribuir para a nossa casa ou para a lua de mel que sonhamos viver juntos, entre Nova Iorque e Hawaii.",
    giftsNote: "Se desejarem contribuir para a nossa nova etapa, deixamos o IBAN.",
    copyIban: "Copiar",
    copySuccess: "IBAN copiado.",
    giftsThanks: "Obrigado por fazerem parte da nossa histÃ³ria.",
    videoTitle: "Nosso vÃ­deo",
    videoSubtitle: "Como nem todos tiveram a oportunidade de nos acompanhar de perto ao longo deste ano, gostarÃ­amos de vos presentear com um pequeno grande momento que resume o nosso amor e que ditou o inÃ­cio desta consagraÃ§Ã£o matrimonial: o nosso pedido de casamento! Cliquem no play, aumentem o som (o vÃ­deo estÃ¡ em bruto pelo que Ã© possÃ­vel que se ouÃ§a um pouco do maravilhoso discurso que o noivo fez Ã  noiva) e esperemos que se emocionem e gostem tanto como nÃ³s â¤ï¸ AtÃ© dia 01 de agosto de 2026.",
    audioSoundOn: "Ativar som",
    audioSoundOff: "Desativar som",
    footerText: "Com amor, InÃªs & Diego",
  },
  "es-pe": {
    heroEyebrow: "InvitaciÃ³n",
    heroTitle: "InÃ©s & Diego",
    heroSubtitle: "1 de agosto de 2026.",
    heroScroll: "Confirma tu presencia",
    langToggle: "PT-PT",
    countdownTitle: "Cuenta regresiva",
    countdownSubtitle: "Para el dÃ­a mÃ¡s especial de nuestras vidas.",
    daysLabel: "DÃ­as",
    hoursLabel: "Horas",
    minutesLabel: "Minutos",
    secondsLabel: "Segundos",
    countdownNote: "La fecha y hora se ajustan en el archivo principal.",
    storyTitle: "Nuestra historia",
    storySubtitle: "PequeÃ±os capÃ­tulos que nos trajeron hasta aquÃ­.",
    story2013: "InÃ©s y Diego se conocieron en los colegios Fomento (Mira-RÃ­o y Planalto).",
    story2014: "Comenzaron a salir demasiado pronto para comprender el amor; el tiempo les mostrÃ³ caminos distintos para madurar.",
    story2016: "Durante una dÃ©cada siguieron trayectorias distintas, pero la amistad se mantuvo firme.",
    story2021: "Crecieron y el destino volviÃ³ a cruzar sus caminos.",
    story2024: "Compraron la primera casa y abrieron la puerta a la vida que querÃ­an compartir.",
    story2025: "Diego le pidiÃ³ a InÃ©s que se casara con Ã©l.",
    story2026: "Â¡El dÃ­a en que prometen ser para siempre!",
    programTitle: "Programa del dÃ­a",
    programSubtitle: "Todo pensado para un dÃ­a inolvidable.",
    programCeremony: "Iglesia de Santo Quintino",
    programCeremonyDesc: "RecepciÃ³n de invitados e inicio de la ceremonia religiosa",
    programToast: "CÃ³ctel de bienvenida",
    programToastDesc: "Llegada a la Quinta de SÃ£o GonÃ§alo",
    programDinner: "Cena",
    programDinnerDesc: "Porque el amor tambiÃ©n se celebra en la mesa",
    programParty: "Fiesta",
    programPartyDesc: "Â¡Bailaremos hasta el amanecer!",
    programPartyEnd: "Ãšltimo brindis",
    programPartyEndDesc: "Despedida y buenos recuerdos",
    locationTitle: "Ubicaciones",
    locationSubtitle: "Dos lugares especiales para nuestro dÃ­a.",
    locationChurchName: "Iglesia de Santo Quintino",
    locationChurchRole: "Ceremonia religiosa",
    locationQuintaName: "Quinta de SÃ£o GonÃ§alo",
    locationQuintaRole: "Brindis y fiesta",
    locationButton: "Abrir en Maps",
    transportTitle: "Transporte",
    transportSubtitle: "La Quinta de SÃ£o GonÃ§alo ofrece aparcamiento a cualquiera que desee traer un coche.",
    transportShuttle: "Transporte organizado",
    transportShuttleDesc: "Se considerarÃ¡ la opciÃ³n de un autobÃºs regular. Si les interesa, por favor, informen a la pareja lo antes posible.",
    transportOwn: "Servicio de drivers",
    transportOwnDesc: "Para garantizar que pueda disfrutar de la ceremonia y las festividades sin preocupaciones, hemos incluido a continuaciÃ³n la informaciÃ³n de contacto de un coordinador del equipo de conductores:",
    galleryTitle: "GalerÃ­a",
    gallerySubtitle: "Â¡Algunos momentos que forman parte de nuestra historia, desde pequeÃ±os hasta hoy!",
    rsvpTitle: "RSVP",
    rsvpSubtitle: "Confirma tu presencia antes del 17 de abril de 2026 para que podamos preparar todo con detalle y con todo nuestro cariÃ±o.",
    rsvpName: "Nombre",
    rsvpGuests: "NÃºmero de invitados",
    rsvpAttendance: "ConfirmaciÃ³n",
    rsvpYes: "SÃ­",
    rsvpNo: "No",
    rsvpNotes: "Â¿Tienes alguna alergia, intolerancia o restricciÃ³n alimentaria?",
    rsvpSubmit: "Enviar confirmaciÃ³n",
    rsvpHelper: "Listo para integrar con email o base de datos.",
    rsvpSuccess: "Gracias. Tu respuesta fue registrada.",
    faqTitle: "Preguntas frecuentes",
    faqSubtitle: "Respuestas rÃ¡pidas a las dudas mÃ¡s comunes.",
    faqDressCode: "CÃ³digo de vestimenta",
    faqDressCodeDesc: "Estamos seguros de que todos los invitados tienen buen gusto, por lo que solo les pedimos que traigan su mejor atuendo. Solo pedimos que eviten el color blanco y tonos similares.",
    faqKids: "HuÃ©spedes",
    faqKidsDesc: "La invitaciÃ³n ya indica las personas que esperamos tener con nosotros ese dÃ­a. Por lo tanto, agradecemos que se respete el nombre de las personas mencionadas en la invitaciÃ³n, para que todo transcurra como planeado.",
    faqSchedule: "Horarios",
    faqScheduleDesc: "Recomendamos que cumpram pontualmente com os horÃ¡rios estipulados. A noiva Ã© a Ãºnica exceÃ§Ã£o, como manda a tradiÃ§Ã£o.",
    faqStay: "Alojamiento",
    faqStayDesc: "Hay hoteles cercanos. EscrÃ­benos para sugerencias.",
    giftsTitle: "Regalos",
    giftsSubtitle: "Su presencia es nuestro mayor regalo, y tenerlos con nosotros hace que este dÃ­a sea inolvidable. Para quienes deseen acompaÃ±arnos de una manera aÃºn mÃ¡s especial, aquÃ­ les dejamos informaciÃ³n sobre cÃ³mo contribuir a nuestro hogar o a la luna de miel que soÃ±amos vivir juntos, entre Nueva York y HawÃ¡i.",
    giftsNote: "Si desean aportar a nuestra nueva etapa, dejamos el IBAN.",
    copyIban: "Copiar",
    copySuccess: "IBAN copiado.",
    giftsThanks: "Gracias por ser parte de nuestra historia.",
    videoTitle: "Nuestro video",
    videoSubtitle: "Como no todos tuvieron la oportunidad de seguirnos de cerca durante este aÃ±o, queremos compartir con ustedes un pequeÃ±o pero significativo momento que resume nuestro amor y marcÃ³ el inicio de esta consagraciÃ³n matrimonial: Â¡nuestra propuesta de matrimonio! Denle play, suban el volumen (el video estÃ¡ sin editar, asÃ­ que pueden escuchar un fragmento del maravilloso discurso que el novio le dio a la novia) y esperamos que se emocionen y lo disfruten tanto como nosotros. â¤ï¸ Hasta el 1 de agosto de 2026.",
    audioSoundOn: "Activar sonido",
    audioSoundOff: "Desactivar sonido",
    footerText: "Con amor, InÃ©s & Diego",
  },
};

const getSavedLang = () => localStorage.getItem("wedding-lang") || "pt-pt";
const setSavedLang = (lang) => localStorage.setItem("wedding-lang", lang);

const applyTranslations = (lang) => {
  const dict = translations[lang] || translations["pt-pt"];
  document.documentElement.lang = lang === "es-pe" ? "es-PE" : "pt-PT";
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) {
      el.textContent = dict[key];
    }
  });
};

const setupCover = () => {
  const coverButton = document.querySelector("[data-cover]");
  const fadeLayer = document.querySelector("[data-fade-layer]");
  if (!coverButton || !fadeLayer) return;

  coverButton.addEventListener("click", () => {
    // ðŸ”“ desbloqueia autoplay no mobile
    const audio = document.querySelector("[data-audio-player]");
    if (audio) {
      audio.muted = false;
      audio.volume = 0.8;
      audio.play().catch(() => { });
      localStorage.setItem("wedding-audio-muted", "false");
    }

    fadeLayer.classList.add("is-active");

    setTimeout(() => {
      window.location.href = "main.html";
    }, 600);
  });
};


const setupCountdown = () => {
  const countdown = document.querySelector("[data-countdown]");
  if (!countdown) return;

  const targetDate = countdown.getAttribute("data-date");
  const target = new Date(targetDate);

  const daysEl = countdown.querySelector("[data-countdown-days]");
  const hoursEl = countdown.querySelector("[data-countdown-hours]");
  const minutesEl = countdown.querySelector("[data-countdown-minutes]");
  const secondsEl = countdown.querySelector("[data-countdown-seconds]");

  const update = () => {
    const now = new Date();
    const diff = target - now;
    const total = Math.max(diff, 0);
    const days = Math.floor(total / (1000 * 60 * 60 * 24));
    const hours = Math.floor((total / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((total / (1000 * 60)) % 60);
    const seconds = Math.floor((total / 1000) % 60);

    daysEl.textContent = days;
    hoursEl.textContent = String(hours).padStart(2, "0");
    minutesEl.textContent = String(minutes).padStart(2, "0");
    secondsEl.textContent = String(seconds).padStart(2, "0");
  };

  update();
  setInterval(update, 1000);
};

const setupLanguageToggle = () => {
  const toggle = document.querySelector("[data-lang-toggle]");
  if (!toggle) return;

  let current = getSavedLang();
  applyTranslations(current);
  document.dispatchEvent(new CustomEvent("languageChanged"));

  toggle.addEventListener("click", () => {
    current = current === "pt-pt" ? "es-pe" : "pt-pt";
    setSavedLang(current);
    applyTranslations(current);
    document.dispatchEvent(new CustomEvent("languageChanged"));
  });
};

const setupReveal = () => {
  const elements = document.querySelectorAll(".reveal");
  if (!elements.length) return;

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("is-visible");
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.2 }
  );

  elements.forEach((el) => observer.observe(el));
};

const setupGallery = () => {
  const lightbox = document.querySelector("[data-lightbox]");
  const lightboxImage = document.querySelector("[data-lightbox-image]");
  const lightboxClose = document.querySelector("[data-lightbox-close]");
  const gallery = document.querySelector("[data-gallery]");

  if (!lightbox || !lightboxImage || !lightboxClose || !gallery) return;

  const open = (src, alt) => {
    lightboxImage.src = src;
    lightboxImage.alt = alt || "";
    lightbox.classList.add("is-active");
    lightbox.setAttribute("aria-hidden", "false");
  };

  const close = () => {
    lightbox.classList.remove("is-active");
    lightbox.setAttribute("aria-hidden", "true");
    lightboxImage.src = "";
  };

  gallery.addEventListener("click", (event) => {
    const img = event.target.closest("img");
    if (!img) return;
    open(img.dataset.full || img.src, img.alt);
  });

  lightboxClose.addEventListener("click", close);
  lightbox.addEventListener("click", (event) => {
    if (event.target === lightbox) {
      close();
    }
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") close();
  });
};

const setupCarousel = () => {
  const carousel = document.querySelector("[data-carousel]");
  if (!carousel) return;

  const track = carousel.querySelector("[data-carousel-track]");
  const prev = carousel.querySelector("[data-carousel-prev]");
  const next = carousel.querySelector("[data-carousel-next]");
  const dots = carousel.querySelector("[data-carousel-dots]");
  if (!track || !prev || !next || !dots) return;

  const slides = Array.from(track.children);
  let index = 0;
  let autoplayInterval = null;
  const AUTOPLAY_DELAY = 2500;

  const startAutoplay = () => {
    stopAutoplay();
    autoplayInterval = setInterval(() => {
      index = (index + 1) % slides.length;
      update();
    }, AUTOPLAY_DELAY);
  };

  const stopAutoplay = () => {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
      autoplayInterval = null;
    }
  };


  const renderDots = () => {
    dots.innerHTML = "";
    slides.forEach((_, i) => {
      const dot = document.createElement("button");
      dot.type = "button";
      dot.className = "carousel__dot";
      dot.setAttribute("aria-label", `Slide ${i + 1}`);
      if (i === index) dot.classList.add("is-active");
      dot.addEventListener("click", () => {
        index = i;
        update();
      });
      dots.appendChild(dot);
    });
  };

  const update = () => {
    track.style.transform = `translateX(-${index * 100}%)`;
    dots.querySelectorAll(".carousel__dot").forEach((dot, i) => {
      dot.classList.toggle("is-active", i === index);
    });
  };

  prev.addEventListener("click", () => {
    index = (index - 1 + slides.length) % slides.length;
    update();
  });

  next.addEventListener("click", () => {
    index = (index + 1) % slides.length;
    update();
  });

  let startX = 0;
  let isDragging = false;

  carousel.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
    isDragging = true;
    stopAutoplay();
  });

  carousel.addEventListener("touchend", (e) => {
    if (!isDragging) return;

    const endX = e.changedTouches[0].clientX;
    const diff = endX - startX;

    if (Math.abs(diff) > 50) {
      if (diff < 0) {
        index = (index + 1) % slides.length;
      } else {
        index = (index - 1 + slides.length) % slides.length;
      }
      update();
    }

    isDragging = false;
    startAutoplay();
  });


  renderDots();
  update();
  startAutoplay();

};

const setupRsvp = () => {
  const form = document.querySelector("[data-rsvp-form]");
  const success = document.querySelector("[data-rsvp-success]");
  if (!form || !success) return;

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const lang = getSavedLang();
    success.textContent = "";

    const data = new FormData(form);

    try {
      const response = await fetch(form.action, {
        method: form.method || "POST",
        body: data,
        headers: {
          Accept: "application/json",
        },
      });

      if (response.ok) {
        success.textContent =
          translations[lang]?.rsvpSuccess ||
          translations["pt-pt"].rsvpSuccess;
        form.reset();
      } else {
        success.textContent =
          lang === "es-pe"
            ? "OcurriÃ³ un error. IntÃ©ntalo de nuevo."
            : "Ocorreu um erro. Tenta novamente.";
      }
    } catch (error) {
      success.textContent =
        lang === "es-pe"
          ? "Error de conexiÃ³n. IntÃ©ntalo mÃ¡s tarde."
          : "Erro de ligaÃ§Ã£o. Tenta mais tarde.";
    }
  });
};

const fireConfetti = () => {
  confetti({
    particleCount: 80,
    spread: 60,
    origin: { y: 0.7 },
  });
};


const setupCopyIban = () => {
  const button = document.querySelector("[data-copy-iban]");
  const iban = document.querySelector("[data-iban]");
  if (!button || !iban) return;

  button.addEventListener("click", async () => {
    const text = iban.textContent.trim();
    try {
      await navigator.clipboard.writeText(text);
      fireConfetti();

    } catch (error) {
      const range = document.createRange();
      range.selectNodeContents(iban);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      document.execCommand("copy");
      fireConfetti();
      selection.removeAllRanges();
    }

    const lang = getSavedLang();
    const label = translations[lang]?.copySuccess || translations["pt-pt"].copySuccess;
    button.querySelector("span").textContent = label;
    setTimeout(() => {
      button.querySelector("span").textContent =
        translations[getSavedLang()]?.copyIban || translations["pt-pt"].copyIban;
    }, 2000);
  });
};

const setupAudioToggle = () => {
  const audio = document.querySelector("[data-audio-player]");
  const toggle = document.querySelector("[data-audio-toggle]");
  if (!audio || !toggle) return;

  const label = toggle.querySelector("[data-i18n]");
  const icon = toggle.querySelector(".audio__icon");

  // state updated by video when it pauses/resumes background audio
  let bgPausedByVideo = false;

  const storedMuted = localStorage.getItem("wedding-audio-muted");

  // regra: se nÃ£o houver preferÃªncia explÃ­cita, comeÃ§a COM som
  if (storedMuted === null) {
    audio.muted = false;
    localStorage.setItem("wedding-audio-muted", "false");
  } else {
    audio.muted = storedMuted === "true";
  }


  const updateLabel = () => {
    const lang = getSavedLang();
    const isSilent = audio.muted || audio.paused || bgPausedByVideo;
    const key = isSilent ? "audioSoundOn" : "audioSoundOff";
    if (label) {
      label.textContent = translations[lang]?.[key] || translations["pt-pt"][key];
    }
    toggle.classList.toggle("is-muted", isSilent);
    toggle.setAttribute("aria-pressed", String(!isSilent));
    if (icon) {
      icon.classList.toggle("is-muted", isSilent);
    }
  };

  const applyState = () => {
    // user manually changed mute state â€” clear any paused-by-video flag
    bgPausedByVideo = false;
    document.dispatchEvent(new CustomEvent("videoBgStateChange", { detail: { pausedByVideo: false } }));

    localStorage.setItem("wedding-audio-muted", String(audio.muted));
    if (audio.muted) {
      audio.pause();
    } else {
      audio.volume = 0.8;
      audio.play().catch(() => { });
    }
    updateLabel();
  };

  toggle.addEventListener("click", () => {
    audio.muted = !audio.muted;
    applyState();
  });

  // reflect video-driven background-pause state in the UI
  document.addEventListener("videoBgStateChange", (e) => {
    bgPausedByVideo = !!(e.detail && e.detail.pausedByVideo);
    // ensure audio playback state matches intent
    if (bgPausedByVideo) {
      if (!audio.paused) audio.pause();
    } else {
      // try to resume if appropriate and if not muted by user
      if (!audio.muted && audio.paused) audio.play().catch(() => { });
    }
    updateLabel();
  });

  audio.addEventListener("play", () => {
    if (audio.muted) {
      audio.pause();
    }
  });

  document.addEventListener("languageChanged", updateLabel);
  // garantir coerÃªncia visual no arranque
  if (!audio.muted) {
    audio.play().catch(() => { });
  }
  updateLabel();

  updateLabel();
};

const setupVideoAudioSync = () => {
  const bgAudio = document.querySelector("[data-audio-player]");
  const video = document.querySelector(".video__player");
  if (!bgAudio || !video) return;

  // track whether background audio was playing and audible
  let wasBgPlaying = !bgAudio.paused && !bgAudio.muted;

  const pauseBg = () => {
    try {
      wasBgPlaying = !bgAudio.paused && !bgAudio.muted;
      if (!bgAudio.paused) bgAudio.pause();
      // notify UI that background audio was paused by video
      document.dispatchEvent(new CustomEvent("videoBgStateChange", { detail: { pausedByVideo: true } }));
    } catch (e) { }
  };

  const resumeBg = () => {
    // notify UI first
    document.dispatchEvent(new CustomEvent("videoBgStateChange", { detail: { pausedByVideo: false } }));
    // respect user mute preference
    if (localStorage.getItem("wedding-audio-muted") === "true") return;
    if (wasBgPlaying) {
      bgAudio.play().catch(() => { });
    }
  };

  // When the video starts playing, pause bg audio only if the video is audible
  video.addEventListener("play", () => {
    if (!video.muted && video.volume > 0) {
      pauseBg();
    }
  });

  // When user pauses or video ends, resume bg audio if appropriate
  video.addEventListener("pause", resumeBg);
  video.addEventListener("ended", resumeBg);

  // If user changes video mute/volume while playing, update bg audio accordingly
  video.addEventListener("volumechange", () => {
    if (video.muted || video.volume === 0) {
      // video became silent â€” resume background if it was playing before
      resumeBg();
    } else {
      // video is audible â€” pause background
      pauseBg();
    }
  });

  // Don't auto-play video when it enters viewport (avoids forcing sound); only pause it when it leaves
  const io = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.target !== video) return;
        if (!entry.isIntersecting) {
          if (!video.paused) {
            video.pause();
          }
        }
      });
    },
    { threshold: 0.6 }
  );

  io.observe(video);
};

document.addEventListener("DOMContentLoaded", () => {
  const currentLang = getSavedLang();
  applyTranslations(currentLang);
  setupCover();
  setupCountdown();
  setupLanguageToggle();
  setupReveal();
  setupGallery();
  setupCarousel();
  setupRsvp();
  setupCopyIban();
  setupAudioToggle();
  setupVideoAudioSync();
});
