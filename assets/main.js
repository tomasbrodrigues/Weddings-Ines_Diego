const translations = {
  "pt-pt": {
    heroEyebrow: "Convite",
    heroTitle: "Inês & Diego",
    heroSubtitle: "1 de agosto de 2026.",
    heroScroll: "Confirma a tua presença",
    langToggle: "ES-PE",
    countdownTitle: "Contagem decrescente",
    countdownSubtitle: "Para o dia mais especial das nossas vidas.",
    daysLabel: "Dias",
    hoursLabel: "Horas",
    minutesLabel: "Minutos",
    secondsLabel: "Segundos",
    countdownNote: "Data e hora podem ser ajustadas no ficheiro principal.",
    storyTitle: "A nossa história",
    storySubtitle: "Pequenos capítulos que nos trouxeram até aqui.",
    story2013:
      "Inês e Diego conheceram-se nos colégios Fomento (Mira-Rio e Planalto).",
    story2014: "Começamos a namorar mas precisamos de crescer e amadurecer.",
    story2016:
      "Mantivemos a nossa amizade e até umas férias de verão com a nossa família tivemos.",
    story2021:
      "O destino voltou a cruzar os nossos caminhos e voltamos a namorar.",
    story2024: "Compramos a nossa primeira casa e fomos viver juntos.",
    story2025: "Diego pediu a Inês em casamento.",
    story2026: "O dia em que dizemos “Sim” para sempre!",
    programTitle: "Programa do dia",
    programSubtitle: "Tudo pensado para um dia inesquecível.",
    programCeremony: "Cerimónia",
    programCeremonyDesc: "Receção dos convidados e início da cerimónia.",
    programToast: "Copo de água",
    programToastDesc: "Brinde e convívio no jardim.",
    programDinner: "Jantar",
    programDinnerDesc: "Menu especial servido no salão principal.",
    programParty: "Festa",
    programPartyDesc: "Música, dança e surpresas até tarde.",
    locationTitle: "Localizações",
    locationSubtitle: "Dois lugares especiais para o nosso dia.",
    locationChurchName: "Igreja de Santo Quintino",
    locationChurchRole: "Cerimónia religiosa",
    locationQuintaName: "Quinta de São Gonçalo",
    locationQuintaRole: "Copo de água e festa",
    locationButton: "Abrir no Maps",
    transportTitle: "Transporte",
    transportSubtitle: "Opções fáceis para chegar com conforto.",
    transportShuttle: "Transporte organizado",
    transportShuttleDesc: "Autocarro disponível a partir do centro do Porto.",
    transportShuttleMeta: "Saída às 13:30 · Regresso às 02:00",
    transportOwn: "Transporte próprio",
    transportOwnDesc: "Estacionamento gratuito disponível no local.",
    transportOwnMeta: "Coordenadas GPS disponíveis no convite.",
    galleryTitle: "Galeria",
    gallerySubtitle: "Alguns momentos que inspiram o nosso dia.",
    rsvpTitle: "RSVP",
    rsvpSubtitle: "Confirma a tua presença para prepararmos tudo com carinho.",
    rsvpName: "Nome",
    rsvpGuests: "Número de convidados",
    rsvpAttendance: "Confirmação",
    rsvpYes: "Sim",
    rsvpNo: "Não",
    rsvpNotes: "Tem alguma alergia, intolerância ou restrição alimentar?",
    rsvpSubmit: "Enviar confirmação",
    rsvpHelper: "Preparado para integração com email ou base de dados.",
    rsvpSuccess: "Obrigado! A tua resposta foi registada.",
    faqTitle: "Perguntas frequentes",
    faqSubtitle: "Respostas rápidas às dúvidas mais comuns.",
    faqDressCode: "Dress code",
    faqDressCodeDesc: "Elegante e confortável. Tons claros são bem-vindos.",
    faqKids: "Crianças",
    faqKidsDesc: "Adoramos os pequenos, por favor indica no RSVP.",
    faqSchedule: "Horários",
    faqScheduleDesc: "Recomendamos chegar 30 minutos antes da cerimónia.",
    faqStay: "Alojamento",
    faqStayDesc:
      "Há hotéis parceiros nas proximidades. Contacta-nos para sugestões.",
    giftsTitle: "Presentes",
    giftsSubtitle: "A vossa presença é o maior presente.",
    giftsNote:
      "Se desejarem contribuir para a nossa nova etapa, deixamos o IBAN.",
    copyIban: "Copiar",
    copySuccess: "IBAN copiado.",
    giftsThanks: "Obrigado por fazerem parte da nossa história.",
    videoTitle: "Nosso vídeo",
    videoSubtitle: "Um momento especial para recordar.",
    audioSoundOn: "Ativar som",
    audioSoundOff: "Desativar som",
    footerText: "Com amor, Inês & Diego",
  },
  "es-pe": {
    heroEyebrow: "Invitación",
    heroTitle: "Inés & Diego",
    heroSubtitle: "1 de agosto de 2026.",
    heroScroll: "Confirma tu presencia",
    langToggle: "PT-PT",
    countdownTitle: "Cuenta regresiva",
    countdownSubtitle: "Para el día más especial de nuestras vidas.",
    daysLabel: "Días",
    hoursLabel: "Horas",
    minutesLabel: "Minutos",
    secondsLabel: "Segundos",
    countdownNote: "La fecha y hora se ajustan en el archivo principal.",
    storyTitle: "Nuestra historia",
    storySubtitle: "Pequeños capítulos que nos trajeron hasta aquí.",
    story2013:
      "Inés y Diego se conocieron en los colegios Fomento (Mira-Río y Planalto).",
    story2014:
      "Empezamos a ser novios, pero necesitábamos crecer y madurar.",
    story2016:
      "Mantuvimos nuestra amistad e incluso compartimos unas vacaciones de verano con la familia.",
    story2021:
      "El destino volvió a cruzar nuestros caminos y retomamos la relación.",
    story2024: "Compramos nuestra primera casa y nos fuimos a vivir juntos.",
    story2025: "Diego le pidió matrimonio a Inés.",
    story2026: "01 de agosto de 2026: ¡el día en que decimos “Sí” para siempre!",
    programTitle: "Programa del día",
    programSubtitle: "Todo pensado para un día inolvidable.",
    programCeremony: "Ceremonia",
    programCeremonyDesc: "Recepción de invitados e inicio de la ceremonia.",
    programToast: "Brindis",
    programToastDesc: "Brindis y encuentro en el jardín.",
    programDinner: "Cena",
    programDinnerDesc: "Menú especial servido en el salón principal.",
    programParty: "Fiesta",
    programPartyDesc: "Música, baile y sorpresas hasta tarde.",
    locationTitle: "Ubicaciones",
    locationSubtitle: "Dos lugares especiales para nuestro día.",
    locationChurchName: "Iglesia de Santo Quintino",
    locationChurchRole: "Ceremonia religiosa",
    locationQuintaName: "Quinta de São Gonçalo",
    locationQuintaRole: "Brindis y fiesta",
    locationButton: "Abrir en Maps",
    transportTitle: "Transporte",
    transportSubtitle: "Opciones fáciles para llegar con comodidad.",
    transportShuttle: "Transporte organizado",
    transportShuttleDesc: "Bus disponible desde el centro de Porto.",
    transportShuttleMeta: "Salida 13:30 · Retorno 02:00",
    transportOwn: "Transporte propio",
    transportOwnDesc: "Estacionamiento gratuito disponible en el lugar.",
    transportOwnMeta: "Coordenadas GPS disponibles en la invitación.",
    galleryTitle: "Galería",
    gallerySubtitle: "Algunos momentos que inspiran nuestro día.",
    rsvpTitle: "RSVP",
    rsvpSubtitle: "Confirma tu asistencia para preparar todo con cariño.",
    rsvpName: "Nombre",
    rsvpGuests: "Número de invitados",
    rsvpAttendance: "Confirmación",
    rsvpYes: "Sí",
    rsvpNo: "No",
    rsvpNotes: "¿Tienes alguna alergia, intolerancia o restricción alimentaria?",
    rsvpSubmit: "Enviar confirmación",
    rsvpHelper: "Listo para integrar con email o base de datos.",
    rsvpSuccess: "Gracias. Tu respuesta fue registrada.",
    faqTitle: "Preguntas frecuentes",
    faqSubtitle: "Respuestas rápidas a las dudas más comunes.",
    faqDressCode: "Código de vestimenta",
    faqDressCodeDesc: "Elegante y cómodo. Tonos claros son bienvenidos.",
    faqKids: "Niños",
    faqKidsDesc: "Nos encantan los pequeños, indícalo en el RSVP.",
    faqSchedule: "Horarios",
    faqScheduleDesc: "Recomendamos llegar 30 minutos antes de la ceremonia.",
    faqStay: "Alojamiento",
    faqStayDesc: "Hay hoteles cercanos. Escríbenos para sugerencias.",
    giftsTitle: "Regalos",
    giftsSubtitle: "Su presencia es el mejor regalo.",
    giftsNote: "Si desean aportar a nuestra nueva etapa, dejamos el IBAN.",
    copyIban: "Copiar",
    copySuccess: "IBAN copiado.",
    giftsThanks: "Gracias por ser parte de nuestra historia.",
    videoTitle: "Nuestro video",
    videoSubtitle: "Un momento especial para recordar.",
    audioSoundOn: "Activar sonido",
    audioSoundOff: "Desactivar sonido",
    footerText: "Con amor, Inés & Diego",
  },
};

const getSavedLang = () => localStorage.getItem("wedding-lang") || "pt-pt";
const setSavedLang = (lang) => localStorage.setItem("wedding-lang", lang);

const applyTranslations = (lang) => {
  const dict = translations[lang] || translations["pt-pt"];
  document.documentElement.lang = lang === "es-pe" ? "es-PE" : "pt-PT";
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) {
      el.textContent = dict[key];
    }
  });
};

const setupCover = () => {
  const coverButton = document.querySelector("[data-cover]");
  const fadeLayer = document.querySelector("[data-fade-layer]");
  if (!coverButton || !fadeLayer) return;

  coverButton.addEventListener("click", () => {
    fadeLayer.classList.add("is-active");
    setTimeout(() => {
      window.location.href = "main.html";
    }, 600);
  });
};

const setupCountdown = () => {
  const countdown = document.querySelector("[data-countdown]");
  if (!countdown) return;

  const targetDate = countdown.getAttribute("data-date");
  const target = new Date(targetDate);

  const daysEl = countdown.querySelector("[data-countdown-days]");
  const hoursEl = countdown.querySelector("[data-countdown-hours]");
  const minutesEl = countdown.querySelector("[data-countdown-minutes]");
  const secondsEl = countdown.querySelector("[data-countdown-seconds]");

  const update = () => {
    const now = new Date();
    const diff = target - now;
    const total = Math.max(diff, 0);
    const days = Math.floor(total / (1000 * 60 * 60 * 24));
    const hours = Math.floor((total / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((total / (1000 * 60)) % 60);
    const seconds = Math.floor((total / 1000) % 60);

    daysEl.textContent = days;
    hoursEl.textContent = String(hours).padStart(2, "0");
    minutesEl.textContent = String(minutes).padStart(2, "0");
    secondsEl.textContent = String(seconds).padStart(2, "0");
  };

  update();
  setInterval(update, 1000);
};

const setupLanguageToggle = () => {
  const toggle = document.querySelector("[data-lang-toggle]");
  if (!toggle) return;

  let current = getSavedLang();
  applyTranslations(current);
  document.dispatchEvent(new CustomEvent("languageChanged"));

  toggle.addEventListener("click", () => {
    current = current === "pt-pt" ? "es-pe" : "pt-pt";
    setSavedLang(current);
    applyTranslations(current);
    document.dispatchEvent(new CustomEvent("languageChanged"));
  });
};

const setupReveal = () => {
  const elements = document.querySelectorAll(".reveal");
  if (!elements.length) return;

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("is-visible");
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.2 }
  );

  elements.forEach((el) => observer.observe(el));
};

const setupGallery = () => {
  const lightbox = document.querySelector("[data-lightbox]");
  const lightboxImage = document.querySelector("[data-lightbox-image]");
  const lightboxClose = document.querySelector("[data-lightbox-close]");
  const gallery = document.querySelector("[data-gallery]");

  if (!lightbox || !lightboxImage || !lightboxClose || !gallery) return;

  const open = (src, alt) => {
    lightboxImage.src = src;
    lightboxImage.alt = alt || "";
    lightbox.classList.add("is-active");
    lightbox.setAttribute("aria-hidden", "false");
  };

  const close = () => {
    lightbox.classList.remove("is-active");
    lightbox.setAttribute("aria-hidden", "true");
    lightboxImage.src = "";
  };

  gallery.addEventListener("click", (event) => {
    const img = event.target.closest("img");
    if (!img) return;
    open(img.dataset.full || img.src, img.alt);
  });

  lightboxClose.addEventListener("click", close);
  lightbox.addEventListener("click", (event) => {
    if (event.target === lightbox) {
      close();
    }
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") close();
  });
};

const setupCarousel = () => {
  const carousel = document.querySelector("[data-carousel]");
  if (!carousel) return;

  const track = carousel.querySelector("[data-carousel-track]");
  const prev = carousel.querySelector("[data-carousel-prev]");
  const next = carousel.querySelector("[data-carousel-next]");
  const dots = carousel.querySelector("[data-carousel-dots]");
  if (!track || !prev || !next || !dots) return;

  const slides = Array.from(track.children);
  let index = 0;
  let autoplayInterval = null;
  const AUTOPLAY_DELAY = 2500;

  const startAutoplay = () => {
    stopAutoplay();
    autoplayInterval = setInterval(() => {
      index = (index + 1) % slides.length;
      update();
    }, AUTOPLAY_DELAY);
  };

  const stopAutoplay = () => {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
      autoplayInterval = null;
    }
  };


  const renderDots = () => {
    dots.innerHTML = "";
    slides.forEach((_, i) => {
      const dot = document.createElement("button");
      dot.type = "button";
      dot.className = "carousel__dot";
      dot.setAttribute("aria-label", `Slide ${i + 1}`);
      if (i === index) dot.classList.add("is-active");
      dot.addEventListener("click", () => {
        index = i;
        update();
      });
      dots.appendChild(dot);
    });
  };

  const update = () => {
    track.style.transform = `translateX(-${index * 100}%)`;
    dots.querySelectorAll(".carousel__dot").forEach((dot, i) => {
      dot.classList.toggle("is-active", i === index);
    });
  };

  prev.addEventListener("click", () => {
    index = (index - 1 + slides.length) % slides.length;
    update();
  });

  next.addEventListener("click", () => {
    index = (index + 1) % slides.length;
    update();
  });

  let startX = 0;
  let isDragging = false;

  carousel.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
    isDragging = true;
    stopAutoplay();
  });

  carousel.addEventListener("touchend", (e) => {
    if (!isDragging) return;

    const endX = e.changedTouches[0].clientX;
    const diff = endX - startX;

    if (Math.abs(diff) > 50) {
      if (diff < 0) {
        index = (index + 1) % slides.length;
      } else {
        index = (index - 1 + slides.length) % slides.length;
      }
      update();
    }

    isDragging = false;
    startAutoplay();
  });


  renderDots();
  update();
  startAutoplay();

};

const setupRsvp = () => {
  const form = document.querySelector("[data-rsvp-form]");
  const success = document.querySelector("[data-rsvp-success]");
  if (!form || !success) return;

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const lang = getSavedLang();
    success.textContent = "";

    const data = new FormData(form);

    try {
      const response = await fetch(form.action, {
        method: form.method || "POST",
        body: data,
        headers: {
          Accept: "application/json",
        },
      });

      if (response.ok) {
        success.textContent =
          translations[lang]?.rsvpSuccess ||
          translations["pt-pt"].rsvpSuccess;
        form.reset();
      } else {
        success.textContent =
          lang === "es-pe"
            ? "Ocurrió un error. Inténtalo de nuevo."
            : "Ocorreu um erro. Tenta novamente.";
      }
    } catch (error) {
      success.textContent =
        lang === "es-pe"
          ? "Error de conexión. Inténtalo más tarde."
          : "Erro de ligação. Tenta mais tarde.";
    }
  });
};

const fireConfetti = () => {
  confetti({
    particleCount: 80,
    spread: 60,
    origin: { y: 0.7 },
  });
};


const setupCopyIban = () => {
  const button = document.querySelector("[data-copy-iban]");
  const iban = document.querySelector("[data-iban]");
  if (!button || !iban) return;

  button.addEventListener("click", async () => {
    const text = iban.textContent.trim();
    try {
      await navigator.clipboard.writeText(text);
      fireConfetti();

    } catch (error) {
      const range = document.createRange();
      range.selectNodeContents(iban);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      document.execCommand("copy");
      fireConfetti();
      selection.removeAllRanges();
    }

    const lang = getSavedLang();
    const label = translations[lang]?.copySuccess || translations["pt-pt"].copySuccess;
    button.querySelector("span").textContent = label;
    setTimeout(() => {
      button.querySelector("span").textContent =
        translations[getSavedLang()]?.copyIban || translations["pt-pt"].copyIban;
    }, 2000);
  });
};

const setupAudioToggle = () => {
  const audio = document.querySelector("[data-audio-player]");
  const toggle = document.querySelector("[data-audio-toggle]");
  if (!audio || !toggle) return;

  const label = toggle.querySelector("[data-i18n]");
  const icon = toggle.querySelector(".audio__icon");
  const storedMuted = localStorage.getItem("wedding-audio-muted");

  if (storedMuted !== null) {
    audio.muted = storedMuted === "true";
  }

  const updateLabel = () => {
    const lang = getSavedLang();
    const key = audio.muted ? "audioSoundOn" : "audioSoundOff";
    if (label) {
      label.textContent = translations[lang]?.[key] || translations["pt-pt"][key];
    }
    toggle.classList.toggle("is-muted", audio.muted);
    toggle.setAttribute("aria-pressed", String(!audio.muted));
    if (icon) {
      icon.classList.toggle("is-muted", audio.muted);
    }
  };

  const applyState = () => {
    localStorage.setItem("wedding-audio-muted", String(audio.muted));
    if (audio.muted) {
      audio.pause();
    } else {
      audio.volume = 0.8;
      audio.play().catch(() => { });
    }
    updateLabel();
  };

  toggle.addEventListener("click", () => {
    audio.muted = !audio.muted;
    applyState();
  });

  audio.addEventListener("play", () => {
    if (audio.muted) {
      audio.pause();
    }
  });

  document.addEventListener("languageChanged", updateLabel);
  updateLabel();
  applyState();
};

document.addEventListener("DOMContentLoaded", () => {
  const currentLang = getSavedLang();
  applyTranslations(currentLang);
  setupCover();
  setupCountdown();
  setupLanguageToggle();
  setupReveal();
  setupGallery();
  setupCarousel();
  setupRsvp();
  setupCopyIban();
  setupAudioToggle();
});
