const translations = {
  "pt-pt": {
    heroEyebrow: "Convite",
    heroTitle: "In√™s & Diego",
    heroSubtitle: "1 de agosto de 2026.",
    heroScroll: "Confirma a tua presen√ßa",
    langToggle: "ES-PE",
    countdownTitle: "Contagem decrescente",
    countdownSubtitle: "Para o dia mais especial das nossas vidas.",
    daysLabel: "Dias",
    hoursLabel: "Horas",
    minutesLabel: "Minutos",
    secondsLabel: "Segundos",
    countdownNote: "Data e hora podem ser ajustadas no ficheiro principal.",
    storyTitle: "A nossa hist√≥ria",
    storySubtitle: "Pequenos cap√≠tulos que nos trouxeram at√© aqui.",
    story2013: "In√™s e Diego conheceram-se nos col√©gios Fomento (Mira-Rio e Planalto).",
    story2014: "Come√ßaram a namorar cedo demais para saber o que era amar, e o tempo indicou-lhes caminhos diferentes para amadurecer.",
    story2016: "Durante uma d√©cada seguiram caminhos distintos, mas a amizade manteve-se firme.",
    story2021: "Cresceram, e o destino voltou a cruzar os seus caminhos.",
    story2024: "Compraram a primeira casa e abriram a porta para a vida que queriam partilhar.",
    story2025: "Diego pediu In√™s em noivado.",
    story2026: "O dia em que prometem ser um para sempre!",
    programTitle: "Programa do dia",
    programSubtitle: "Tudo pensado para um dia inesquec√≠vel.",
    programCeremony: "Igreja Santo Quintino",
    programCeremonyDesc: "Rece√ß√£o dos convidados e in√≠cio da cerim√≥nia religiosa",
    programToast: "Cocktail de Boas-Vindas",
    programToastDesc: "Chegada √† Quinta de S√£o Gon√ßalo",
    programDinner: "Jantar",
    programDinnerDesc: "Porque o amor tamb√©m se celebra √† mesa",
    programParty: "Festa",
    programPartyDesc: "Vamos dan√ßar at√© amanhecer!",
    programPartyEnd: "√öltimo brinde",
    programPartyEndDesc: "Despedida e boas mem√≥rias",
    locationTitle: "Localiza√ß√µes",
    locationSubtitle: "Dois lugares especiais para o nosso dia.",
    locationChurchName: "Igreja de Santo Quintino",
    locationChurchRole: "Cerim√≥nia religiosa",
    locationQuintaName: "Quinta de S√£o Gon√ßalo",
    locationQuintaRole: "Copo de √°gua e festa",
    locationButton: "Abrir no Maps",
    transportTitle: "Transporte",
    transportSubtitle: "A Quinta de S√£o Gon√ßalo oferece estacionamento a todos os que pretenderem levar carro.",
    transportShuttle: "Transporte organizado",
    transportShuttleDesc: "Ser√° estudado a op√ß√£o de um autocarro comum. Pedimos que, caso estejam interessados, informem os noivos com brevidade.",
    transportOwn: "Servi√ßo de Drivers",
    transportOwnDesc: "Para que possam usufruir da cerim√≥nia e festas sem preocupa√ß√µes, partilhamos o contacto de um coordenador de uma equipa de drivers:",
    galleryTitle: "Galeria",
    gallerySubtitle: "Alguns momentos que fazem parte da nossa hist√≥ria, desde mais pequenos at√© hoje!",
    rsvpTitle: "RSVP",
    rsvpSubtitle: "Confirma a tua presen√ßa at√© <strong>01 de maio de 2026</strong> para que possamos preparar tudo ao detalhe e com todo o nosso carinho.",
    rsvpName: "Nome",
    rsvpGuests: "E-mail",
    rsvpAttendance: "Confirma√ß√£o",
    rsvpYes: "Sim",
    rsvpNo: "N√£o",
    rsvpNotes: "Tem alguma alergia, intoler√¢ncia ou restri√ß√£o alimentar?",
    rsvpSubmit: "Enviar confirma√ß√£o",
    rsvpHelper: "Preparado para integra√ß√£o com email ou base de dados.",
    rsvpSuccess: "Obrigado! A tua resposta foi registada.",
    faqTitle: "Perguntas frequentes",
    faqSubtitle: "Respostas r√°pidas √†s d√∫vidas mais comuns.",
    faqDressCode: "Dress code",
    faqDressCodeDesc: "Estamos certos que todos os convidados t√™m bom gosto, pelo que apenas pedimos que tragam o vosso melhor outfit! Pedimos somente que evitem a cor branca e tons semelhantes.",
    faqKids: "Convidados",
    faqKidsDesc: "O convite j√° indica as pessoas que contamos ter connosco nesse dia. Agradecemos, por isso, que seja respeitado o nome das pessoas mencionadas no convite, para que tudo decorra como planeado.",
    faqSchedule: "Hor√°rios",
    faqScheduleDesc: "Recomendamos que cumpram pontualmente com os hor√°rios estipulados. A noiva √© a √∫nica exce√ß√£o, como manda a tradi√ß√£o.",
    faqStay: "Alojamento",
    faqStayDesc:
      "H√° hot√©is parceiros nas proximidades. Contacta-nos para sugest√µes.",
    giftsTitle: "Presentes",
    giftsSubtitle: "A vossa presen√ßa √© o nosso maior presente, e t√™-los connosco torna este dia j√° inesquec√≠vel. Para quem quiser juntar-se a n√≥s de forma ainda mais especial, deixamos aqui informa√ß√µes para contribuir para a nossa casa ou para a lua de mel que sonhamos viver juntos, entre Nova Iorque e Hawaii.",
    giftsNote: "Se desejarem contribuir para a nossa nova etapa, deixamos o IBAN.",
    copyIban: "Copiar",
    copySuccess: "IBAN copiado.",
    giftsThanks: "Obrigado por fazerem parte da nossa hist√≥ria.",
    videoTitle: "Nosso v√≠deo",
    videoSubtitle: "Como nem todos tiveram a oportunidade de nos acompanhar de perto ao longo deste ano, gostar√≠amos de vos presentear com um pequeno grande momento que resume o nosso amor e que ditou o in√≠cio desta consagra√ß√£o matrimonial: o nosso pedido de casamento! Cliquem no play, aumentem o som (o v√≠deo est√° em bruto pelo que √© poss√≠vel que se ou√ßa um pouco do maravilhoso discurso que o noivo fez √† noiva) e esperemos que se emocionem e gostem tanto como n√≥s ‚ù§Ô∏è At√© dia 01 de agosto de 2026.",
    audioSoundOn: "Ativar som",
    audioSoundOff: "Desativar som",
    footerText: "Com amor, In√™s & Diego",
  },
  "es-pe": {
    heroEyebrow: "Invitaci√≥n",
    heroTitle: "In√©s & Diego",
    heroSubtitle: "1 de agosto de 2026.",
    heroScroll: "Confirma tu presencia",
    langToggle: "PT-PT",
    countdownTitle: "Cuenta regresiva",
    countdownSubtitle: "Para el d√≠a m√°s especial de nuestras vidas.",
    daysLabel: "D√≠as",
    hoursLabel: "Horas",
    minutesLabel: "Minutos",
    secondsLabel: "Segundos",
    countdownNote: "La fecha y hora se ajustan en el archivo principal.",
    storyTitle: "Nuestra historia",
    storySubtitle: "Peque√±os cap√≠tulos que nos trajeron hasta aqu√≠.",
    story2013: "In√©s y Diego se conocieron en los colegios Fomento (Mira-R√≠o y Planalto).",
    story2014: "Comenzaron a salir demasiado j√≥venes para saber lo que era amar, y el tiempo les indic√≥ caminos diferentes para madurar.",
    story2016: "Durante una d√©cada siguieron trayectorias distintas, pero la amistad se mantuvo firme.",
    story2021: "Crecieron y el destino volvi√≥ a cruzar sus caminos.",
    story2024: "Compraron la primera casa y abrieron la puerta a la vida que quer√≠an compartir.",
    story2025: "Diego le pidi√≥ a In√©s que se casara con √©l.",
    story2026: "¬°El d√≠a en que prometen ser para siempre!",
    programTitle: "Programa del d√≠a",
    programSubtitle: "Todo pensado para un d√≠a inolvidable.",
    programCeremony: "Iglesia de Santo Quintino",
    programCeremonyDesc: "Recepci√≥n de invitados e inicio de la ceremonia religiosa",
    programToast: "C√≥ctel de bienvenida",
    programToastDesc: "Llegada a la Quinta de S√£o Gon√ßalo",
    programDinner: "Cena",
    programDinnerDesc: "Porque el amor tambi√©n se celebra en la mesa",
    programParty: "Fiesta",
    programPartyDesc: "¬°Bailaremos hasta el amanecer!",
    programPartyEnd: "√öltimo brindis",
    programPartyEndDesc: "Despedida y buenos recuerdos",
    locationTitle: "Ubicaciones",
    locationSubtitle: "Dos lugares especiales para nuestro d√≠a.",
    locationChurchName: "Iglesia de Santo Quintino",
    locationChurchRole: "Ceremonia religiosa",
    locationQuintaName: "Quinta de S√£o Gon√ßalo",
    locationQuintaRole: "Brindis y fiesta",
    locationButton: "Abrir en Maps",
    transportTitle: "Transporte",
    transportSubtitle: "La Quinta de S√£o Gon√ßalo ofrece aparcamiento a cualquiera que desee traer un coche.",
    transportShuttle: "Transporte organizado",
    transportShuttleDesc: "Se considerar√° la opci√≥n de un autob√∫s regular. Si les interesa, por favor, informen a la pareja lo antes posible.",
    transportOwn: "Servicio de drivers",
    transportOwnDesc: "Para garantizar que pueda disfrutar de la ceremonia y las festividades sin preocupaciones, hemos incluido a continuaci√≥n la informaci√≥n de contacto de un coordinador del equipo de conductores:",
    galleryTitle: "Galer√≠a",
    gallerySubtitle: "¬°Algunos momentos que forman parte de nuestra historia, desde peque√±os hasta hoy!",
    rsvpTitle: "RSVP",
    rsvpSubtitle: "Confirma tu presencia antes del <strong>01 de mayo de 2026</strong> para que podamos preparar todo con detalle y con todo nuestro cari√±o.",
    rsvpName: "Nombre",
    rsvpGuests: "E-mail",
    rsvpAttendance: "Confirmaci√≥n",
    rsvpYes: "S√≠",
    rsvpNo: "No",
    rsvpNotes: "¬øTienes alguna alergia, intolerancia o restricci√≥n alimentaria?",
    rsvpSubmit: "Enviar confirmaci√≥n",
    rsvpHelper: "Listo para integrar con email o base de datos.",
    rsvpSuccess: "Gracias. Tu respuesta fue registrada.",
    faqTitle: "Preguntas frecuentes",
    faqSubtitle: "Respuestas r√°pidas a las dudas m√°s comunes.",
    faqDressCode: "C√≥digo de vestimenta",
    faqDressCodeDesc: "Estamos seguros de que todos los invitados tienen buen gusto, por lo que solo les pedimos que traigan su mejor atuendo. Solo pedimos que eviten el color blanco y tonos similares.",
    faqKids: "Hu√©spedes",
    faqKidsDesc: "La invitaci√≥n ya indica las personas que esperamos tener con nosotros ese d√≠a. Por lo tanto, agradecemos que se respete el nombre de las personas mencionadas en la invitaci√≥n, para que todo transcurra como planeado.",
    faqSchedule: "Horarios",
    faqScheduleDesc: "Recomendamos que cumpram pontualmente com os hor√°rios estipulados. A noiva √© a √∫nica exce√ß√£o, como manda a tradi√ß√£o.",
    faqStay: "Alojamiento",
    faqStayDesc: "Hay hoteles cercanos. Escr√≠benos para sugerencias.",
    giftsTitle: "Regalos",
    giftsSubtitle: "Su presencia es nuestro mayor regalo, y tenerlos con nosotros hace que este d√≠a sea inolvidable. Para quienes deseen acompa√±arnos de una manera a√∫n m√°s especial, aqu√≠ les dejamos informaci√≥n sobre c√≥mo contribuir a nuestro hogar o a la luna de miel que so√±amos vivir juntos, entre Nueva York y Haw√°i.",
    giftsNote: "Si desean aportar a nuestra nueva etapa, dejamos el IBAN.",
    copyIban: "Copiar",
    copySuccess: "IBAN copiado.",
    giftsThanks: "Gracias por ser parte de nuestra historia.",
    videoTitle: "Nuestro video",
    videoSubtitle: "Como no todos tuvieron la oportunidad de seguirnos de cerca durante este a√±o, queremos compartir con ustedes un peque√±o pero significativo momento que resume nuestro amor y marc√≥ el inicio de esta consagraci√≥n matrimonial: ¬°nuestra propuesta de matrimonio! Denle play, suban el volumen (el video est√° sin editar, as√≠ que pueden escuchar un fragmento del maravilloso discurso que el novio le dio a la novia) y esperamos que se emocionen y lo disfruten tanto como nosotros. ‚ù§Ô∏è Hasta el 1 de agosto de 2026.",
    audioSoundOn: "Activar sonido",
    audioSoundOff: "Desactivar sonido",
    footerText: "Con amor, In√©s & Diego",
  },
};

const getSavedLang = () => localStorage.getItem("wedding-lang") || "pt-pt";
const setSavedLang = (lang) => localStorage.setItem("wedding-lang", lang);

const applyTranslations = (lang) => {
  const dict = translations[lang] || translations["pt-pt"];
  document.documentElement.lang = lang === "es-pe" ? "es-PE" : "pt-PT";
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) {
      el.innerHTML = dict[key];
    }
  });
};

const setupCover = () => {
  const coverButton = document.querySelector("[data-cover]");
  const fadeLayer = document.querySelector("[data-fade-layer]");
  if (!coverButton || !fadeLayer) return;

  coverButton.addEventListener("click", () => {
    // üîì desbloqueia autoplay no mobile
    const audio = document.querySelector("[data-audio-player]");
    if (audio) {
      audio.muted = false;
      audio.volume = 0.8;
      audio.play().catch(() => { });
      localStorage.setItem("wedding-audio-muted", "false");
    }

    fadeLayer.classList.add("is-active");

    setTimeout(() => {
      window.location.href = "/invite";
    }, 600);
  });
};


const setupCountdown = () => {
  const countdown = document.querySelector("[data-countdown]");
  if (!countdown) return;

  const targetDate = countdown.getAttribute("data-date");
  const target = new Date(targetDate);

  const daysEl = countdown.querySelector("[data-countdown-days]");
  const hoursEl = countdown.querySelector("[data-countdown-hours]");
  const minutesEl = countdown.querySelector("[data-countdown-minutes]");
  const secondsEl = countdown.querySelector("[data-countdown-seconds]");

  const update = () => {
    const now = new Date();
    const diff = target - now;
    const total = Math.max(diff, 0);
    const days = Math.floor(total / (1000 * 60 * 60 * 24));
    const hours = Math.floor((total / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((total / (1000 * 60)) % 60);
    const seconds = Math.floor((total / 1000) % 60);

    daysEl.textContent = days;
    hoursEl.textContent = String(hours).padStart(2, "0");
    minutesEl.textContent = String(minutes).padStart(2, "0");
    secondsEl.textContent = String(seconds).padStart(2, "0");
  };

  update();
  setInterval(update, 1000);
};

const setupLanguageToggle = () => {
  const toggle = document.querySelector("[data-lang-toggle]");
  if (!toggle) return;

  let current = getSavedLang();
  applyTranslations(current);
  document.dispatchEvent(new CustomEvent("languageChanged"));

  toggle.addEventListener("click", () => {
    current = current === "pt-pt" ? "es-pe" : "pt-pt";
    setSavedLang(current);
    applyTranslations(current);
    document.dispatchEvent(new CustomEvent("languageChanged"));
  });
};

const setupReveal = () => {
  const elements = document.querySelectorAll(".reveal");
  if (!elements.length) return;

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("is-visible");
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.2 }
  );

  elements.forEach((el) => observer.observe(el));
};

const setupGallery = () => {
  const lightbox = document.querySelector("[data-lightbox]");
  const lightboxImage = document.querySelector("[data-lightbox-image]");
  const lightboxClose = document.querySelector("[data-lightbox-close]");
  const gallery = document.querySelector("[data-gallery]");

  if (!lightbox || !lightboxImage || !lightboxClose || !gallery) return;

  const open = (src, alt) => {
    lightboxImage.src = src;
    lightboxImage.alt = alt || "";
    lightbox.classList.add("is-active");
    lightbox.setAttribute("aria-hidden", "false");
  };

  const close = () => {
    lightbox.classList.remove("is-active");
    lightbox.setAttribute("aria-hidden", "true");
    lightboxImage.src = "";
  };

  gallery.addEventListener("click", (event) => {
    const img = event.target.closest("img");
    if (!img) return;
    open(img.dataset.full || img.src, img.alt);
  });

  lightboxClose.addEventListener("click", close);
  lightbox.addEventListener("click", (event) => {
    if (event.target === lightbox) {
      close();
    }
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") close();
  });
};

const setupCarousel = () => {
  const carousel = document.querySelector("[data-carousel]");
  if (!carousel) return;

  const track = carousel.querySelector("[data-carousel-track]");
  const prev = carousel.querySelector("[data-carousel-prev]");
  const next = carousel.querySelector("[data-carousel-next]");
  const dots = carousel.querySelector("[data-carousel-dots]");
  if (!track || !prev || !next || !dots) return;

  const slides = Array.from(track.children);
  let index = 0;
  let autoplayInterval = null;
  const AUTOPLAY_DELAY = 2500;

  const startAutoplay = () => {
    stopAutoplay();
    autoplayInterval = setInterval(() => {
      index = (index + 1) % slides.length;
      update();
    }, AUTOPLAY_DELAY);
  };

  const stopAutoplay = () => {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
      autoplayInterval = null;
    }
  };


  const renderDots = () => {
    dots.innerHTML = "";
    slides.forEach((_, i) => {
      const dot = document.createElement("button");
      dot.type = "button";
      dot.className = "carousel__dot";
      dot.setAttribute("aria-label", `Slide ${i + 1}`);
      if (i === index) dot.classList.add("is-active");
      dot.addEventListener("click", () => {
        index = i;
        update();
      });
      dots.appendChild(dot);
    });
  };

  const update = () => {
    track.style.transform = `translateX(-${index * 100}%)`;
    dots.querySelectorAll(".carousel__dot").forEach((dot, i) => {
      dot.classList.toggle("is-active", i === index);
    });
  };

  prev.addEventListener("click", () => {
    index = (index - 1 + slides.length) % slides.length;
    update();
  });

  next.addEventListener("click", () => {
    index = (index + 1) % slides.length;
    update();
  });

  let startX = 0;
  let isDragging = false;

  carousel.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
    isDragging = true;
    stopAutoplay();
  });

  carousel.addEventListener("touchend", (e) => {
    if (!isDragging) return;

    const endX = e.changedTouches[0].clientX;
    const diff = endX - startX;

    if (Math.abs(diff) > 50) {
      if (diff < 0) {
        index = (index + 1) % slides.length;
      } else {
        index = (index - 1 + slides.length) % slides.length;
      }
      update();
    }

    isDragging = false;
    startAutoplay();
  });


  renderDots();
  update();
  startAutoplay();

};

const setupRsvp = () => {
  const form = document.querySelector("[data-rsvp-form]");
  const success = document.querySelector("[data-rsvp-success]");
  if (!form || !success) return;

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const lang = getSavedLang();
    success.textContent = "";

    const data = new FormData(form);

    try {
      const response = await fetch(form.action, {
        method: form.method || "POST",
        body: data,
        headers: {
          Accept: "application/json",
        },
      });

      if (response.ok) {
        success.textContent =
          translations[lang]?.rsvpSuccess ||
          translations["pt-pt"].rsvpSuccess;
        form.reset();
      } else {
        success.textContent =
          lang === "es-pe"
            ? "Ocurri√≥ un error. Int√©ntalo de nuevo."
            : "Ocorreu um erro. Tenta novamente.";
      }
    } catch (error) {
      success.textContent =
        lang === "es-pe"
          ? "Error de conexi√≥n. Int√©ntalo m√°s tarde."
          : "Erro de liga√ß√£o. Tenta mais tarde.";
    }
  });
};

const fireConfetti = () => {
  confetti({
    particleCount: 80,
    spread: 60,
    origin: { y: 0.7 },
  });
};


const setupCopyIban = () => {
  const button = document.querySelector("[data-copy-iban]");
  const iban = document.querySelector("[data-iban]");
  if (!button || !iban) return;

  button.addEventListener("click", async () => {
    const text = iban.textContent.trim();
    try {
      await navigator.clipboard.writeText(text);
      fireConfetti();

    } catch (error) {
      const range = document.createRange();
      range.selectNodeContents(iban);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      document.execCommand("copy");
      fireConfetti();
      selection.removeAllRanges();
    }

    const lang = getSavedLang();
    const label = translations[lang]?.copySuccess || translations["pt-pt"].copySuccess;
    button.querySelector("span").textContent = label;
    setTimeout(() => {
      button.querySelector("span").textContent =
        translations[getSavedLang()]?.copyIban || translations["pt-pt"].copyIban;
    }, 2000);
  });
};

const setupAudioToggle = () => {
  const audio = document.querySelector("[data-audio-player]");
  const toggle = document.querySelector("[data-audio-toggle]");
  if (!audio || !toggle) return;

  const label = toggle.querySelector("[data-i18n]");
  const icon = toggle.querySelector(".audio__icon");

  // state updated by video when it pauses/resumes background audio
  let bgPausedByVideo = false;

  const storedMuted = localStorage.getItem("wedding-audio-muted");

  // regra: se n√£o houver prefer√™ncia expl√≠cita, come√ßa COM som
  if (storedMuted === null) {
    audio.muted = false;
    localStorage.setItem("wedding-audio-muted", "false");
  } else {
    audio.muted = storedMuted === "true";
  }


  const updateLabel = () => {
    const lang = getSavedLang();
    const isSilent = audio.muted || audio.paused || bgPausedByVideo;
    const key = isSilent ? "audioSoundOn" : "audioSoundOff";
    if (label) {
      label.textContent = translations[lang]?.[key] || translations["pt-pt"][key];
    }
    toggle.classList.toggle("is-muted", isSilent);
    toggle.setAttribute("aria-pressed", String(!isSilent));
    if (icon) {
      icon.classList.toggle("is-muted", isSilent);
    }
  };

  const applyState = () => {
    // user manually changed mute state ‚Äî clear any paused-by-video flag
    bgPausedByVideo = false;
    document.dispatchEvent(new CustomEvent("videoBgStateChange", { detail: { pausedByVideo: false } }));

    localStorage.setItem("wedding-audio-muted", String(audio.muted));
    if (audio.muted) {
      audio.pause();
    } else {
      audio.volume = 0.8;
      audio.play().catch(() => { });
    }
    updateLabel();
  };

  toggle.addEventListener("click", () => {
    audio.muted = !audio.muted;
    applyState();
  });

  // reflect video-driven background-pause state in the UI
  document.addEventListener("videoBgStateChange", (e) => {
    bgPausedByVideo = !!(e.detail && e.detail.pausedByVideo);
    // ensure audio playback state matches intent
    if (bgPausedByVideo) {
      if (!audio.paused) audio.pause();
    } else {
      // try to resume if appropriate and if not muted by user
      if (!audio.muted && audio.paused) audio.play().catch(() => { });
    }
    updateLabel();
  });

  audio.addEventListener("play", () => {
    if (audio.muted) {
      audio.pause();
    }
  });

  document.addEventListener("languageChanged", updateLabel);
  // garantir coer√™ncia visual no arranque
  if (!audio.muted) {
    audio.play().catch(() => { });
  }
  updateLabel();

  updateLabel();
};

const setupVideoAudioSync = () => {
  const bgAudio = document.querySelector("[data-audio-player]");
  const video = document.querySelector(".video__player");
  if (!bgAudio || !video) return;

  // track whether background audio was playing and audible
  let wasBgPlaying = !bgAudio.paused && !bgAudio.muted;

  const pauseBg = () => {
    try {
      wasBgPlaying = !bgAudio.paused && !bgAudio.muted;
      if (!bgAudio.paused) bgAudio.pause();
      // notify UI that background audio was paused by video
      document.dispatchEvent(new CustomEvent("videoBgStateChange", { detail: { pausedByVideo: true } }));
    } catch (e) { }
  };

  const resumeBg = () => {
    // notify UI first
    document.dispatchEvent(new CustomEvent("videoBgStateChange", { detail: { pausedByVideo: false } }));
    // respect user mute preference
    if (localStorage.getItem("wedding-audio-muted") === "true") return;
    if (wasBgPlaying) {
      bgAudio.play().catch(() => { });
    }
  };

  // When the video starts playing, pause bg audio only if the video is audible
  video.addEventListener("play", () => {
    if (!video.muted && video.volume > 0) {
      pauseBg();
    }
  });

  // When user pauses or video ends, resume bg audio if appropriate
  video.addEventListener("pause", resumeBg);
  video.addEventListener("ended", resumeBg);

  // If user changes video mute/volume while playing, update bg audio accordingly
  video.addEventListener("volumechange", () => {
    if (video.muted || video.volume === 0) {
      // video became silent ‚Äî resume background if it was playing before
      resumeBg();
    } else {
      // video is audible ‚Äî pause background
      pauseBg();
    }
  });

  // Don't auto-play video when it enters viewport (avoids forcing sound); only pause it when it leaves
  const io = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.target !== video) return;
        if (!entry.isIntersecting) {
          if (!video.paused) {
            video.pause();
          }
        }
      });
    },
    { threshold: 0.6 }
  );

  io.observe(video);
};

document.addEventListener("DOMContentLoaded", () => {
  const currentLang = getSavedLang();
  applyTranslations(currentLang);
  setupCover();
  setupCountdown();
  setupLanguageToggle();
  setupReveal();
  setupGallery();
  setupCarousel();
  setupRsvp();
  setupCopyIban();
  setupAudioToggle();
  setupVideoAudioSync();
});
